# Using NOVA-CAN to develop on micro-controllers

Nova-CAN is designed to to simplify and standardise the development of microcontroller code by generating message passing and callbacks based on the on an interface `.yaml` format. The main [README](./README.md) described how the interface `.yaml` file is formated.

## Code Generation Tool (NCC)

The Nova CAN Compiler (NCC) is the core tool that transforms device configurations into usable C code.

### What NCC Generates

1. **Device Header File**: Contains all necessary includes and function declarations
2. **Callback Function Signatures**: Ready-to-implement function prototypes
3. **Message Multiplexing**: Automatic routing of incoming messages to correct callbacks
4. **Service Handling**: Request/response processing for services
5. **CAN ID Processing**: Automatic deserialization of CAN frames

### Generated Functions

```c
// Main receive function (call this in your main loop)
int nova_can_motor_driver_rx(uint32_t *can_id, uint8_t *data, size_t* length);

// Individual callback functions (implement these)
int nova_can_motor_driver_command_callback(NOVA_CAN_CANID *can_id, 
                                          nova_motor_driver_msg_Command_1_0 *data);
int nova_can_motor_driver_set_pidconstant_callback(NOVA_CAN_CANID *can_id,
                                                   nova_motor_driver_srv_SetPIDConstant_Request_1_0 *data);
```

### NCC Usage
To generate C code run:
```bash
ncc -d your_device.yaml -o output_folder
```

**Arguments:**
- `-d, --device-interface`: Path to device interface YAML file
- `-o, --output-folder`: Directory to place generated files

The generated code is header only, C99 code and is compatible with PIC hardware (tested). Note, the code generator has
float serialization disabled as it is generally not suitable for microcontroller development.

## Current Limitations

- **Service Responses**: Service response sending is not yet implemented
- **Multi-frame Support**: Large message handling is planned but not implemented

## Workflow with microcontrollers

1. **Create a device `.yaml` file**

2. **Generate code with:**
```bash
ncc -d your_device.yaml -o output_folder
```

3. **Add generated code to include directories and include the device**
   ```c
   #include "your_device.h"  // Generated by NCC
   ```

//TODO

2. **Initialize CAN Hardware**
   ```c
   // Configure your CAN controller
   // Set up hardware filters using nova_can_get_canid_filter/mask
   uint32_t filter, mask;
   nova_can_get_canid_filter(NODE_ID, &filter);
   nova_can_get_canid_mask(&mask);
   // Apply to your hardware
   ```

3. **Implement Callbacks**
   ```c
   // NCC generates these signatures - implement the logic
   int nova_can_your_device_message_callback(NOVA_CAN_CANID *can_id, 
                                             message_type *data) {
       // Your device-specific handling
       return 0;
   }
   ```

4. **Message Processing Loop**
   ```c
   while (1) {
       // Read CAN frame from your hardware
       if (your_can_receive(&frame)) {
           // Process with generated Nova-CAN function
           nova_can_your_device_rx(&frame.id, frame.data, &frame.length);
       }
   }
   ```